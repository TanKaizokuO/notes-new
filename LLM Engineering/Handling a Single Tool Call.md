---
tags:
  - extension
created: 2026-02-01
---
---

When the LLM decides to call a tool, the API response has a specific `finish_reason` of `"tool_calls"`. We must intercept this, run the code, and report back.

---
# ðŸ§  In one line

Your code does:

```
User â†’ LLM â†’ Tool Call â†’ Python Function â†’ Tool Result â†’ LLM â†’ Final Reply
```

---

## Python Implementation

```python
import json
import openai

def chat(message, history):
    # Standard setup
    history = [{"role": h["role"], "content": h["content"]} for h in history]
    messages = [{"role": "system", "content": system_message}] + history + [{"role": "user", "content": message}]
    
    # 1. First Call: Send query + tool definitions
    response = openai.chat.completions.create(model=MODEL, messages=messages, tools=tools)
    
    # 2. Check if LLM wants to use a tool
    if response.choices[0].finish_reason == "tool_calls":
        message_obj = response.choices[0].message
        
        # 3. Execute the tool logic
        tool_response = handle_tool_call(message_obj)
        
        # 4. Append interaction to history
        messages.append(message_obj) # Add the assistant's request to call tool
        messages.append(tool_response) # Add the tool's result
        
        # 5. Second Call: Get final natural language answer
        response = openai.chat.completions.create(model=MODEL, messages=messages)
        
    return response.choices[0].message.content

def handle_tool_call(message):
    tool_call = message.tool_calls[0] # Assumes only 1 tool call for now
    
    if tool_call.function.name == "get_ticket_price":
        # Parse arguments generated by LLM
        arguments = json.loads(tool_call.function.arguments)
        city = arguments.get('destination_city')
        
        # Run actual Python function
        price_details = get_ticket_price(city)
        
        # Format response for the API
        return {
            "role": "tool",
            "content": price_details,
            "tool_call_id": tool_call.id
        }        
```


---

# Step By Step Explaination

> **User:** `london`  
> **Tool result:** `The price of a ticket to London is $799`  
> **Final reply:** `The price of a ticket to London is $799.`

---

## ðŸ”¹ Step 1 â€” Build the prompt

```python
messages = [{"role": "system", "content": system_message}] + history + [{"role": "user", "content": message}]
```

Creates:

```
system: You are FlightAI...
user: london
```

This is sent to OpenAI along with `tools`.

---

## ðŸ”¹ Step 2 â€” First OpenAI call

```python
response = openai.chat.completions.create(..., tools=tools)
```

The model sees `"london"` and decides:

> â€œI should call `get_ticket_price`.â€

So instead of text, it returns:

```
finish_reason = "tool_calls"
tool_calls = get_ticket_price({"destination_city":"London"})
```

No user-facing answer yet.

---
## ðŸ”¹ Step 3 â€” Execute tool (`handle_tool_call`)

Inside:

```python
tool_call = message.tool_calls[0]
arguments = json.loads(tool_call.function.arguments)
city = "London"
price_details = get_ticket_price("London")
```

Your Python backend runs:

```
get_ticket_price("London")
â†’ "The price of a ticket to London is $799"
```

Then you wrap it:

```python
{
  "role": "tool",
  "content": "The price of a ticket to London is $799",
  "tool_call_id": ...
}
```

This is the **tool response**.

---

## ðŸ”¹ Step 4 â€” Append tool interaction

```python
messages.append(message_obj)   # assistant requested tool
messages.append(tool_response) # tool returned $799
```

Conversation now looks like:

```
system: FlightAI rules
user: london
assistant: (calls get_ticket_price)
tool: The price of a ticket to London is $799
```

---

## ðŸ”¹ Step 5 â€” Second OpenAI call (final answer)

```python
response = openai.chat.completions.create(model=MODEL, messages=messages)
```

Now the LLM sees the tool result and converts it into natural language:

```
"The price of a ticket to London is $799."
```

---

## âœ… Final return

```python
return response.choices[0].message.content
```

User receives:

> **The price of a ticket to London is $799.**

---

